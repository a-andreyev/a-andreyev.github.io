---
layout: post
title: "AngelHack 2016 в Санкт-Петербурге: Sailfish OS IoT project"
date: '2016-06-13'
categories: posts
# ru: true
tags:
- Jolla
- Sailfish
- OMP
- Angelhack 

---

История о том, как я поучаствовал в [AngelHack 2016 в Санкт-Петербурге](http://apps4all.ru/post/06-17-16-aleksej-andreev-sailfish-iot-project-hochu-dobavit-podderzhku-golosa-v-klient-sailfish-dlya-umnyh-chasov-pebble-time),
в котором собранная мной команда
выиграла в номинации от Открытой Мобильной Платформы
"на лучшее использование платформы Sailfish OS"!

![sailfish_winners](/assets/img/posts/2016-06-13-angelhack-sailfish/sailfish_winners.jpg)
<!--more-->

## Disclamer

Проект, с которым мы выиграли в хакатоне, посвящен разработкам для [Sailfish OS](https://sailfishos.org/),
позволяющим реализовывать концепции Internet of Things.
Мы делали прототип домашнего потребительского устройства на основе ESP8266,
для Arduino-прошивки поднимали [CoAP](http://coap.technology)-сервер с опциями `observe` и `discovery`.

Смело пролистывайте лирические вступления до частей с деталями реализации (ближе к середине)!

## Как Jolla Sailfish стал моим телефоном

Из приятно впечатливших меня телефонов у меня когда-то были:

+ Ericsson t20s
+ Siemens A50
+ Sony Ericsson T230
+ Siemens M65
+ Nokia 3250
+ [Motorola Motoming A1200](http://forum.motofan.ru/index.php?showforum=158),
+ Motorola C118
+ какой-то Samsung типа Е1100
+ и особенно -- Nokia N9.

[Но однажды пару-тройку лет назад в Петербурге в minijack моей N9 попало немного воды с проезжающего мимо гидроцикла](/assets/img/posts/junk/crying_pepe.jpg),
и как-то совсем неудачно -- стал вопрос о замене всей платы.

Омраченный происшествием с любимой N9, я не захотел сразу искать Jolla.
Сначала я решил попробовать ранний Windows Phone...
Через пару дней вернул новый телефон продавцам (вернул без проблем).
После посмотрел в сторону Android:
нашел китайский IP67-защищенный [Lenovo S750](http://4pda.ru/forum/index.php?showtopic=474871) на Android 4.2,
залил на него прошивку с оболочкой MIUI
и более-менее довольный ходил с ним примерно год, но скучал по N9.
Захотев поиграться, я выяснил, что от MTK-процессоров [в ближайшем будущем](/assets/img/posts/junk/scott_pilgrim_the_future_like_with_jetpacks.png) не жди никаких Cyanogen-ов, как и обновлений от Lenovo -- и стало скучно. Позже телефон вдобавок перестал ловить сеть, и, скорее всего, требуется [что-то подобное](https://www.youtube.com/watch?v=pJWgrkFBZeg).
Оказалось, что Android мне мало чем интересен,
[я не особенно жалую Java](/assets/img/posts/junk/sojava.jpg).
Продуцию же Apple я и до этого обходил стороной.

На десктопах у меня к тому времени уже продолжительное время стояли кеды со всякими арчлинуксами,
и, как я не оттягивал время, мне жутко интересен был Jolla Sailfish.
Мне понравился их интерфейс сразу, [еще по первым презентациям](/assets/img/posts/junk/histercatj.jpg),
но немного смущали всякие слоганы #unlike, хотелось чего-то поскромнее.
В итоге я все-таки купил Jolla Sailfish в официальном магазине, когда они еще были там, и до сих пор хожу с ним, не нарадуюсь.

![Jolla Sailfish terminal screenshot](/assets/img/posts/2016-06-13-angelhack-sailfish/sshots/20160719134523.jpg)
![Jolla Sailfish desktop screenshot](/assets/img/posts/2016-06-13-angelhack-sailfish/sshots/20160719132923.jpg)
<!---
fixme: compress image:
-->
![le me as hipsta](/assets/img/posts/2016-06-13-angelhack-sailfish/P50811-181752.jpg)
![Jolla Sailfish text editing screenshot](/assets/img/posts/2016-06-13-angelhack-sailfish/sshots/20160719131905.jpg)

## Как я узнал о хакатоне AngelHack и номинации от Открытой Мобильной Платформы

О хакатоне я узнал из рассылок [FRUCT](http://fruct.org/)-а. О FRUCT узнать было несложно, когда приехал Петербург
и интересуешься Qt и мобильными линуксами.
[Мое знакомство](#TODO: tizen logo) с FRUCT состоялось на каком-то из хакатонов по TizenOS.
Но Tizen мне [не приглянулся иконками](/assets/img/posts/junk/boringthesame.jpg) и [html-приложениями](/assets/img/posts/junk/htmlcssjs.png).

<!---
[TODO: tizen bage shot]()
-->

Позже я посещал [первый meetup от FRUCT по Sailfish в Петербурге](http://fruct.org/sailfish1) и другие мероприятия,
а в рассылке о хакатоне было объявлено, что за день до самого мероприятия пройдет [еще один (второй) митап для разработчиков](http://fruct.org/SailfishOS1).
На обоих, кстати, были представители Jolla и Открытой Мобильной Платформы, что приятно,
т.к. можно было расспрашивать их о чем угодно.

Например, я расспрашивал про отношение Silica и Qt Quick Controls. Как я понял, исторически получилось, что первое начало развиваться до появления второго. А их объединение оценивается как слабо осуществимое на практике, т.к. имеет смысл для очень ограниченного круга задач с интерфейсами (слишком различается взаимодействие с десктопом и тач-мобильными-жестами). Но, если захотеть, то самому, конечно, можно сделать для конкретного приложения общие для десктопа и тач-скрина мобильных устройств компоненты. Мечтать[[1](https://together.jolla.com/question/71520/request-qtquick-controls/),[2](https://together.jolla.com/question/98438/develop-application-using-standard-qt-modules/)] о чем-то вроде стиля Silica для Qt labs Controls и скором обновлении Qt в системе до 5.6 всё равно приятно.

Спрашивал еще про [tracker](https://github.com/GNOME/tracker) и планы на его будущее в Sailfish. Насколько я уяснил, он хорошо себя показал при работе с метаданными о мультимедиа-коллекции пользователя, но никто особо заморачиваться с ним не хочет. Убирать его не собираются, но и полностью покрывать им всю систему -- тоже. Тем более, что всякие фэйсбуки не дают по своим правилам что-то свободно скачивать с их серваков и нормально кэшировать (тут могу сильно ошибаться). Мне вопрос интересен, т.к. я люблю RDF/Semantic Web/etc, да и в рассылках на смежные темы [шел разговор](https://lists.sailfishos.org/pipermail/devel/2016-June/007173.html).

## Время перед хакатоном

Пролистав весь список зарегистрированных проектов я увидел, что ни одного из них по Sailfish не было.
Немного подождав, я зарегистрировался сам, но ни заявок в команду, ни проектов-конкуретов не увидел.

Отсутствие конкурентов смущало, т.к. сложно было решить, к чему готовиться.
Отсутствие заявок в команду -- тоже, т.к. до последнего я не был уверен, что смогу участвовать в хакатоне оба дня. Даты хакатона в Петербурге: 11-12 июня, а 13-е -- мой День рождения.

Празднование Дня рождения с друзьями планировалось в ночь с 12-го на 13 июня еще до того, как я узнал о хакатоне, было забронировано место, приглашены гости.
Поэтому я очень переживал, что не успеваю на самую важную часть хакатона (презентацию результатов), и хотел поскорее собрать команду,
которая смогла бы представить результаты без меня, если понадобится.

За день до митапа для разработчиков (за 2 дня до хакатона) на мой проект откликнулся дизайнер.
Я объяснил ему, что да как насчет проекта и того, что я хочу уехать вечером с главной части для подготовки Д.Р.
Сказал, что готов взять его к себе.
Он ответил, что один человек на демонстрации -- не очень хорошо,
но что больше никого все равно искать не стоит, чтобы доля каждого от еще невыигранного приза была выше.

Приехав на митап разработчиков (1 день до хакатона) я встретил там знакомого по первому митапу -- Вову.
Он сказал, что тоже хочет участвовать, и спросил, есть ли у меня проект.
Не смотря на то, что дизайнер предлагал никого больше не брать, я сказал Вове, что хочу взять его к себе и объяснил ситуацию насчет того, что пока не знаю, успеваю ли сам.

После митапа выяснилось, что один из моих друзей сильно приболел и не сможет прийти на праздник. Из-за этого решили все перенести, когда он выздоровит, всё удачно. Друг поправился через пару недель и собрал всех уже на свой Д.Р.
Время на выходных полностью освободилось для хакатона.
Я сказал дизайнеру, извинившись, что его брать не буду, оставив только Вову.

## Хакатон

Не имея особенного опыта участия в подобных мероприятиях, я набрал походный рюкзак свяких Arduino-подобных железок, Raspberry Pi, прочей мелочи, паяльников и тому подобного.
И захватил спальный мешок и зубную щетку.
В итоге спать мы не ложились (хотя свободных кресел и диванов было предостаточно), а из железок приспособили только одну. Но это был очень необычный опыт -- ехать на хакатон со спальником.

### Регистрация, сбор команды

Я старался приехать как можно раньше,
и пришел на место еще до того, как открылась регистрация.
В здании мне сразу понравилось, было чисто и светло (какой-то из корпусов ВШЭ, арендованный на время мероприятия).
На пуфиках у столов с регистрацией уже сидели несколько ребят-участников и Слава из Jolla.

Слава пошутил, что призы нужно давать всем, кто вообще решил прийти на первый хакатон по Sailfish,
но Кирилл из Открытой Мобильной платформы объяснил, что это обсуждалось,
и конечное решение в ОМП было за один крупный приз.

Вова пришел. За чаем в столовой выяснилось,
что у нас у обоих есть забытый богом (и сотрудниками Toshiba)
клёвый смартбук: [Toshiba AC100](http://4pda.ru/forum/index.php?showtopic=198800) (у меня 117-ый, у него 116-ый).
Я очень люблю корпус/железо этого устройства (и очень не долюбливаю его программную часть),
поэтому мне этот факт [запомнился](https://www.youtube.com/watch?v=TF-yKm0c1tQ).

Перед началом хакатона нужно было выступить как лидер проекта,
рассказав об идеях и о том, нужны ли тебе еще люди (максимум: 4 человека в команде).
У меня в заявках был еще разработчик, и он пришел.
Заранее немного прогуглив информацию о нем, мне показалось,
что я не хотел бы брать его в команду (очень субъективно, без каких-либо причин).
Позже я сильно переживал, что не беру того, кто сам попросился ко мне, но всё-таки не поменял своего решения.

Этот человек решил оставаться и тоже участвовать в номинации по Sailfish,
так что он был первым соперником (он не был в какой-то команде, был один).

После выступления мне пришло уведомление о новой заявке от разработчика.
Так я познакомился с Петром. По текущей работе он занимался питоном и rpg-играми, но имел опыт с плюсами и ранее занимался исследовательской деятельностью. С первых минут общения я решил, что нужно его звать к себе, и не пожалел. Мы очень хорошо сработались, как мне кажется. Он поговорил с ребятами со всех доступных команд и остался с нами.

### Начало работы, идея проекта

<!---
питон и ssh
появились другие ребята.
bluetooth не осилили его, другой чувак тоже, qr-коды лучше.
-->

Каждой команде выделили огромные просторные места, бесплатное питание (обеды, ужины и закуски/попить/фрукты на ночь). Хакатон занял несколько этажей, в каждой аудитории было по паре команд. Мы были по соседству с ребятами, занимающимися VR/AR-проектами, все приветливые. Первое, что пришло в голову -- спорсить их про недавний на то время видос ["HYPER-REALITY"](https://vimeo.com/166807261), который мне очень нравится. Так и познакомились, обменялись контактами.

В рамках проекта задумка была такая:

1. Взять дешевые WiFi-модули ESP8266, подключить на них все датчики и актуаторы, что успеем
(диоды-лампочки, серво-приводы, датчики температуры и влажности, кнопки, пьезо-пищалки, датчики освещенности, кнопки)
1. Прошить [Arduino-прошивку](https://github.com/esp8266/Arduino) в модули,
используя [существующие наработки](https://github.com/semiotproject/minicoap) для протокола [CoAP](http://coap.technology).
1. Подготовить мобильный клиент для Sailfish,
позволяющий обнаруживать CoAP-устройства в локальной сети, работать с их ресурсами, подписываться на происходящие изменения,
базируясь на [Qt-библиотеке для CoAP](https://github.com/t-mon/qtcoap).
1. Посмотреть в сторону таких проектов, как [Saera](https://openrepos.net/content/taixzo/saera) и прикрутить голосовые команды к нашему мобильному клиенту.
1. ???
1. По возможности не попасть в упоминание [@internetofshit в твиттерах](https://twitter.com/internetofshit).


Было решено распределить время следующим образом:

+ До утра я смотрю за сроками, готовлю железки, помогаю ребятам с их задачами.
+ Вова готовит мобильный клиент с поддержкой протокола CoAP.
+ Петя смотрит решения по использованию распознования речи.
+ Утром готовим презентацию, записываем на видео результаты, т.к. время выступления ограничено

У меня был свой смартфон Jolla Sailfish, но при этом всем выдали рабочий прототип новых моделей Intex / Jolla C.

Эксперты-судьи из ОМП и Jolla дружелюбно помогали всем участникам. Обсуждали идеи, советовали, как их лучше развить.

Кирилл подсказывал, как, например, удачнее [связать QML и C++ логику](https://vk.com/wall-40681615_7896), давал советы по SDK. У Пети установщик SDK для linux не завелся на его ноуте, из-за каких-то особенностей с драйверами для WiFi -- ушел в бесконечное ожидание. Не долго думая, запустили [live-образ с флэшки, подготовленный Кириллом](https://vk.com/wall-40681615_7885) (кстати, не забывайте включать аппаратную виртуализацию в загрузчике, она нужна Virtualbox из SDK).

Слава подготавливал [VNC-сервер](https://together.jolla.com/question/32196#post-id-136359) для удобной демонстрации на будущих презентациях, подкидывал дополнительных идей по работе с атмосферами и смс-ками. И еще поднял нам на Jolla C дополнительную WiFi-сетку. Как и в большинстве универов, где я был раньше, в этом тоже были параноидально закрыты все порты, кроме 80 и вроде 22.

![at work](/assets/img/posts/2016-06-13-angelhack-sailfish/with_slava_from_jolla.jpg)

Т.к. можно было принимать участие в нескольких номинациях, мы выбрали еще номинацию Google с их beacon-маячками и Physical Web. Но быстро отказались от этой затеи, т.к. у меня были подозрения, что с текущей версией BlueZ или чем-то подобным на устройстве могут возникнуть дополнительные сложности, которые мы не осилим по времени. Эксперт с гугла приходил к нам, создал впечатление отлично разбирающего в своем деле специалисте. Он посоветовал нам также посмотреть в сторону Firebase для хранения данных с датчиков, и сказал, что в текущей версии она должна уметь работать и локально при временном отсутствии интернетов (на что мы больше всего ориентировались). Но мы не посмотрели, т.к. я планировал использовать знакомый мне CoAP и организовывать более простую по архитектуре систему. Возможно, напрасно, и сейчас Firebase у меня в todo и закладках.

Мы [создали команду на гитхабе](https://github.com/sailpirates) и взялись за дело.

#### CoAP (RFC 7252 Constrained Application Protocol)
[CoAP](http://coap.technology/) -- бинарный протокол, работающий поверх UDP (При желании -- поверх TCP или даже SMS). Для безопасности предлагается DTLS. Разрабатывается для систем с ограниченными ресурсами, близок по областям применения к MQTT. Вот [тут](http://www.eclipse.org/community/eclipse_newsletter/2014/february/article2.php) разработчик библиотеки на Си для микроконтроллеров хорошо сравнивает их.

Если грубо, то CoAP -- больше для взаимодействия один-на-один с устройством в духе REST, а MQTT -- для организации потока событий многие-ко-многим через промежуточные узлы.

Ребята, работающие над Wireshark, напрямую взаимодействуют с авторами стандарта и поддерживают развитие CoAP, поэтому протокол поддерживается приложением из коробки. Это очень удобно при отладке.

Протокол, в свою очередь, позволяет организовать ресурсы и доступ к ним по [Link-формату](http://tools.ietf.org/html/rfc6690). В общем, это очень похоже на легкий бинарный HTTP (есть те же `GET`, `POST`, `PUT`, `DELETE` и стандартные ответы ошибок), с возможностью обнаруживать доступные сервера, получать список их ресурсов и метаданные о них и подписываться на изменения.

Для тестов есть публичные сервера [coap.me](http://coap.me/) и [еще один с observe-ресурсами из вуза в Швейцарии](http://vs0.inf.ethz.ch/). А также куча приложений, библиотек и плагин для Firefox.

Мы собирались использовать набор библиотек Arduino, для него уже была готова библиотека [microcoap](https://github.com/1248/microcoap), фокусирующаяся на экономии ресурсов. Поддержки подписок на ресурсы для получения информации об их изменении добавлено не было, поэтому я худо-бедно [добавил ее сам](https://github.com/semiotproject/minicoap) до хакатона в рамках своей работы в аспирантуре.

#### ESP8266

ESP8266 -- мега-популярный дешевый WiFi-модуль (SoC) от Espressif. Революция в мире IoT и тому подобное. К осени ждем от них ESP32 с BLE.

Для ESP8266 некто Иван Грохотков поддерживает шикарную [Arduino-совместимость](https://github.com/esp8266/Arduino) (берут SDK устройства и пишут реализацию ардуиновских библиотек).

Для хакатона я принес несколько ESP8266, подключал диод-лампочку и подготавливал CoAP-ресурсы:

+ `/led1` -- принимающий 1 байт со значением яркости для ШИМ-модуляции и оповещающий остальных клиентов-подписчиков об изменениях
+ `/.well-known/core` -- стандартный ресурс, выдающий список остальных ресурсов, используемый для discovery-обнаружения устройств

Конечно, еще несколько датчиков и актуаторов приспособить было уже быстрее, но дошли мы только до первого.

#### Мобильный клиент Sailfish

Для мобильного клиента мы поискали библиотеки для CoAP на Qt и нашли [qcoap](https://github.com/romixlab/qcoap) и [qtcoap](https://github.com/t-mon/qtcoap). Выбрали второй, т.к. дома до хакатона у меня быстрее получилось поднять его на десктопном приложении, но оба проекта интересные. Я показал их Вове и пояснял какие-то идеи, а он занимался логикой поиска устройств и доступа к кокретным ресурсам, а также организацией нативных Silica-страничек интерфейса.

Он форкал позже qtcoap в нашу команду на гитхабе, т.к. ему не нравилась его архитектура, кажется (но могу путать).

#### Голосовое управление

Перед хакатоном я нашел проект Saera[[1](https://openrepos.net/content/taixzo/saera),[2](https://github.com/taixzo/saera),[3](https://talk.maemo.org/showthread.php?t=84753),[4](https://www.indiegogo.com/projects/supporting-the-development-of-saera-on-sailfishos)]. На Jolla 1 дома у меня все запустилось и работало. Если использовать локальное распознавание голоса (на основе Sphinx и ).

На Jolla C аналоге -- не получилось. Мы пытались, Петя его форкал, патчил. Но на гитхабе, кажется, была не совсем актуальная по сравнению с собранной в OpenRepos версия. Не осили, в общем.

![hacking](/assets/img/posts/2016-06-13-angelhack-sailfish/photo_2016-07-21_18-18-00.jpg)

### Ночь, hacking time

Ближе к вечеру начали ощущаться сложности.
<!---
saera тупит, голосовые серваки лежат, устройства перезагружаются от статики без подтягивающих резисторов. тестировали на распберии с арчилинуксом, но плохой инет и убили ее. белые ночи, ночь пробежала очень быстро и только когда прозвенел будильник я ощутил, что давно не спал.
-->

![at work](/assets/img/posts/2016-06-13-angelhack-sailfish/team_at_work.jpg)

### Утро, подготовка к презентации

<!---
у нас были закуски и все необходимое и мы кушали ночью. ребята решили сходить на завтрак, я решил добить wifi-модуль и он, наконец, поддался, начав запускаться.
презентация и видео.
-->

### Завершение мероприятия

<!---
вова уехал по делам домой, мы остались с петей. самая длинная часть. до последней секунды волнуешься.
другие проекты: один пропустили, запомнилось про очистить спб от рекламы
заполнили документы, поболтали по душам с остальными участниками, кириллом и славой и поехали с петей по домам.
-->

## После хакатона

Я выспался, вернулся к работе и стал готовить эту статью и всякие документы на получение приза.
С этим, правда, возникли сложности, т.к. при подаче документов выяснилось, что кроме банковских реквизитов, сканов паспорта и номера ИНН необходимо предоставить скан свидетельства из налоговой.
За ним пришлось ехать по месту жительства в другой город, как я не старался это сделать удалённо. Документы в итоге подал, но с задержкой.
Обновлю это предложение, когда получу приз.

Нас позвали на [Sailfish Community Event](https://blog.jolla.com/international-sailfish-community-event-recap/) в Хельсинки. У Вовы была готова виза, и он смог выбраться побывать на этом мероприятии.

Кроме того, выяснилось через вк, что один парень с Ижевска занимается мобильным голосовым помощником, используя сервисы Яндекса. Мы договорились объединить усилия.

Я приблизился к планам по поддержке голосового функционала для мобильного клиента Pebble Time, чему очень рад.

Кирилл пригласил меня поучаствовать в организации [летней школы по Sailfish в Иннополисе](https://university.innopolis.ru/events/letniy-vorkshop-sailfish-os/).
Вова тоже думал поехать, но, как я понял, из-за задержек с выплатой приза -- у него не получилось выбраться.

В целом от хакатона остались только положительные впечатления, и я без раздумий хотел бы поучаствовать в чем-то подобном снова. Желательно, [снова связанным с Qt](https://www.youtube.com/watch?v=Y6_Xjme9RMI), конечно :)

## Ресуры

+ [vk: Sailfish OS & Co \[Mer, Nemo\] ](https://vk.com/merproject)
+ [Telegram: Jolla Fan Club](https://telegram.me/joinchat/AWx9iQYZwXbqA3Qwl986SQ)
+ [Silica Reference Docs](https://sailfishos.org/develop/docs/silica/sailfish-silica-all.html)
+ [Sailfish HW Adaptations status](https://wiki.merproject.org/wiki/Adaptations/libhybris)
